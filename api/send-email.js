const nodemailer = require("nodemailer");
const validator = require("validator");

// Stockage simple en m√©moire pour le rate limiting (en production, utiliser Redis)
const emailAttempts = new Map();

console.log("üîß API Email - Module charg√© avec succ√®s");

// Fonction de nettoyage p√©riodique des tentatives
setInterval(() => {
  const now = Date.now();
  for (const [ip, data] of emailAttempts.entries()) {
    if (now - data.lastAttempt > 60 * 60 * 1000) {
      // Nettoyer apr√®s 1h
      emailAttempts.delete(ip);
    }
  }
}, 10 * 60 * 1000);

// Rate limiting simple
function checkRateLimit(ip) {
  console.log(`üï∞Ô∏è V√©rification rate limit pour IP: ${ip}`);
  const now = Date.now();
  const userData = emailAttempts.get(ip) || { count: 0, lastAttempt: 0 };

  // Reset si plus d'1 heure
  if (now - userData.lastAttempt > 60 * 60 * 1000) {
    userData.count = 0;
    console.log(`üîÑ Reset du compteur pour IP: ${ip}`);
  }

  userData.count++;
  userData.lastAttempt = now;
  emailAttempts.set(ip, userData);

  // Limite : 5 emails par heure par IP
  const allowed = userData.count <= 5;
  console.log(
    `üìä Rate limit - IP: ${ip}, Count: ${userData.count}/5, Allowed: ${allowed}`
  );
  return allowed;
}

// Fonction de validation et nettoyage des donn√©es
function validateAndSanitize(data) {
  console.log("üîç D√©but de la validation des donn√©es");
  const { name, email, subject, message } = data;

  // Validation de base
  if (!name || !email || !subject || !message) {
    console.log("‚ùå Validation √©chou√©e: champs manquants");
    throw new Error("Tous les champs sont requis");
  }

  // Validation de l'email
  if (!validator.isEmail(email)) {
    console.log(`‚ùå Email invalide: ${email}`);
    throw new Error("Format d'email invalide");
  }

  // Validation des longueurs
  if (name.length > 100) {
    console.log(`‚ùå Nom trop long: ${name.length} caract√®res`);
    throw new Error("Le nom est trop long (max 100 caract√®res)");
  }

  if (subject.length > 200) {
    console.log(`‚ùå Sujet trop long: ${subject.length} caract√®res`);
    throw new Error("Le sujet est trop long (max 200 caract√®res)");
  }

  if (message.length > 2000) {
    console.log(`‚ùå Message trop long: ${message.length} caract√®res`);
    throw new Error("Le message est trop long (max 2000 caract√®res)");
  }

  console.log("üßπ Nettoyage et √©chappement des donn√©es");
  // √âchappement HTML et nettoyage
  const cleanName = validator.escape(name.trim());
  const cleanEmail = validator.normalizeEmail(email.trim());
  const cleanSubject = validator.escape(subject.trim());
  const cleanMessage = validator.escape(message.trim());

  // V√©rification anti-spam basique
  console.log("üõ°Ô∏è V√©rification anti-spam");
  const spamKeywords = [
    "viagra",
    "casino",
    "lottery",
    "winner",
    "crypto",
    "bitcoin",
  ];
  const fullText = (cleanName + cleanSubject + cleanMessage).toLowerCase();

  for (const keyword of spamKeywords) {
    if (fullText.includes(keyword)) {
      console.log(`‚ùå Spam d√©tect√© avec le mot-cl√©: ${keyword}`);
      throw new Error("Message d√©tect√© comme spam");
    }
  }

  console.log("‚úÖ Validation r√©ussie");
  return {
    name: cleanName,
    email: cleanEmail,
    subject: cleanSubject,
    message: cleanMessage,
  };
}

module.exports = async (req, res) => {
  console.log(`üìß API Email - Nouvelle requ√™te: ${req.method} ${req.url}`);

  // Headers de s√©curit√©
  res.setHeader("X-Content-Type-Options", "nosniff");
  res.setHeader("X-Frame-Options", "DENY");
  res.setHeader("X-XSS-Protection", "1; mode=block");

  if (req.method === "POST") {
    try {
      console.log("üì• Traitement d'une requ√™te POST");

      // Rate limiting par IP
      const clientIp =
        req.headers["x-forwarded-for"] ||
        req.connection.remoteAddress ||
        "unknown";

      console.log(`üåê IP client d√©tect√©e: ${clientIp}`);

      if (!checkRateLimit(clientIp)) {
        console.log("üö´ Rate limit d√©pass√©");
        return res.status(429).json({
          message: "Trop d'emails envoy√©s. Veuillez r√©essayer dans une heure.",
        });
      }

      console.log("üìù Validation et nettoyage des donn√©es en cours...");
      // Validation et nettoyage des donn√©es
      const cleanData = validateAndSanitize(req.body);
      console.log("‚úÖ Donn√©es valid√©es et nettoy√©es avec succ√®s");

      // V√©rification des variables d'environnement
      console.log("üîë V√©rification des variables d'environnement...");
      if (!process.env.EMAIL_USER || !process.env.EMAIL_PASS) {
        console.error("‚ùå Variables d'environnement EMAIL manquantes");
        console.log(`EMAIL_USER pr√©sent: ${!!process.env.EMAIL_USER}`);
        console.log(`EMAIL_PASS pr√©sent: ${!!process.env.EMAIL_PASS}`);
        return res.status(500).json({
          message: "Configuration email manquante",
        });
      }
      console.log("‚úÖ Variables d'environnement OK");

      // Configuration du transporteur email
      console.log("üìÆ Configuration du transporteur email...");
      const transporter = nodemailer.createTransport({
        host: "ssl0.ovh.net",
        port: 465,
        secure: true,
        auth: {
          user: process.env.EMAIL_USER,
          pass: process.env.EMAIL_PASS,
        },
        logger: true, // Activer les logs d√©taill√©s temporairement pour diagnostic
        debug: true,
      });
      console.log("‚úÖ Transporteur email configur√©");

      // Test de connexion SMTP
      console.log("üîó Test de connexion SMTP...");
      try {
        await transporter.verify();
        console.log("‚úÖ Connexion SMTP valid√©e avec succ√®s");
      } catch (verifyError) {
        console.error("‚ùå Erreur de connexion SMTP:");
        console.error("üìÑ Message:", verifyError.message);
        console.error("üìä Code:", verifyError.code);
        return res.status(500).json({
          message: "Erreur de configuration email",
        });
      }

      // Envoi de l'email avec contenu nettoy√©
      console.log("üì§ Tentative d'envoi de l'email...");
      try {
        const mailOptions = {
          from: `"MerciLille Contact" <${process.env.EMAIL_USER}>`, // Nom d'affichage + email
          replyTo: `"${cleanData.name}" <${cleanData.email}>`, // Nom + email en reply-to
          to: process.env.EMAIL_USER,
          subject: `[MerciLille] ${cleanData.subject}`,
          // Headers additionnels pour am√©liorer la d√©livrabilit√©
          headers: {
            "X-Mailer": "MerciLille Contact Form",
            "X-Priority": "3",
            "X-MSMail-Priority": "Normal",
            "Message-ID": `<${Date.now()}.${Math.random()
              .toString(36)
              .substr(2, 9)}@mercilille.com>`,
          },
          text: `De: ${cleanData.name} (${cleanData.email})\n\nMessage: ${cleanData.message}`,
          html: `
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Contact depuis MerciLille</title>
            </head>
            <body style="margin: 0; padding: 0; background-color: #f4f4f4;">
              <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f4; padding: 20px;">
                <tr>
                  <td align="center">
                    <table width="600" cellpadding="0" cellspacing="0" style="background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                      <tr style="background-color: #333;">
                        <td style="padding: 20px; text-align: center;">
                          <h1 style="color: white; margin: 0; font-family: Arial, sans-serif;">MerciLille</h1>
                          <p style="color: #ccc; margin: 5px 0 0 0; font-family: Arial, sans-serif;">Nouveau message de contact</p>
                        </td>
                      </tr>
                      <tr>
                        <td style="padding: 30px; font-family: Arial, sans-serif;">
                          <table width="100%" cellpadding="0" cellspacing="0">
                            <tr>
                              <td style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                <strong style="color: #333;">Nom:</strong><br>
                                <span style="color: #666;">${
                                  cleanData.name
                                }</span>
                              </td>
                            </tr>
                            <tr>
                              <td style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                <strong style="color: #333;">Email:</strong><br>
                                <a href="mailto:${
                                  cleanData.email
                                }" style="color: #0066cc; text-decoration: none;">${
            cleanData.email
          }</a>
                              </td>
                            </tr>
                            <tr>
                              <td style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                <strong style="color: #333;">Sujet:</strong><br>
                                <span style="color: #666;">${
                                  cleanData.subject
                                }</span>
                              </td>
                            </tr>
                            <tr>
                              <td style="padding: 20px 0;">
                                <strong style="color: #333;">Message:</strong><br>
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px; line-height: 1.6; color: #444;">
                                  ${cleanData.message.replace(/\n/g, "<br>")}
                                </div>
                              </td>
                            </tr>
                          </table>
                        </td>
                      </tr>
                      <tr style="background-color: #f8f8f8;">
                        <td style="padding: 15px; text-align: center; font-family: Arial, sans-serif; font-size: 12px; color: #888;">
                          Ce message a √©t√© envoy√© depuis le formulaire de contact de mercilille.com
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
            </html>
          `,
        };

        console.log(`üìß Envoi vers: ${process.env.EMAIL_USER}`);
        console.log(`üìã Sujet: [Contact Site] ${cleanData.subject}`);

        const info = await transporter.sendMail(mailOptions);

        console.log("‚úÖ Email envoy√© avec succ√®s!");
        console.log(`üì® Message ID: ${info.messageId || "N/A"}`);
        console.log(`üì¨ Response: ${info.response || "N/A"}`);
        console.log(`üìä Accepted: ${JSON.stringify(info.accepted || [])}`);
        console.log(`‚ùå Rejected: ${JSON.stringify(info.rejected || [])}`);
        console.log(`‚ö†Ô∏è  Pending: ${JSON.stringify(info.pending || [])}`);
        console.log(`üè† Envelope: ${JSON.stringify(info.envelope || {})}`);

        res.status(200).json({
          message: "Email envoy√© avec succ√®s",
          details: {
            messageId: info.messageId,
            accepted: info.accepted,
            rejected: info.rejected,
            response: info.response,
          },
        });
      } catch (error) {
        console.error("‚ùå Erreur lors de l'envoi de l'email:");
        console.error("üìÑ Message:", error.message);
        console.error("üìä Code:", error.code);
        console.error("üìã Response:", error.response);
        res.status(500).json({
          message: "Erreur lors de l'envoi de l'email",
        });
      }
    } catch (error) {
      console.error("‚ùå Erreur g√©n√©rale dans l'API:");
      console.error("üìÑ Message:", error.message);
      console.error("üìä Stack:", error.stack);
      // Erreurs de validation
      return res.status(400).json({
        message: error.message || "Donn√©es invalides",
      });
    }
  } else {
    console.log(`‚ùå M√©thode non autoris√©e: ${req.method}`);
    res.setHeader("Allow", ["POST"]);
    res.status(405).json({ message: `M√©thode ${req.method} non autoris√©e` });
  }
};
